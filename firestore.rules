rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── 검증 함수 ──

    function isValidUserDoc() {
      let data = request.resource.data;
      let keys = data.keys();
      return keys.size() <= 20
        && (!('teacherName' in keys) || (data.teacherName is string && data.teacherName.size() <= 30))
        && (!('consentVersion' in keys) || (data.consentVersion is string && data.consentVersion.size() <= 10))
        && (!('schoolLevel' in keys) || (data.schoolLevel is string && data.schoolLevel.size() <= 20))
        && (!('selectedClassId' in keys) || data.selectedClassId == null || (data.selectedClassId is string && data.selectedClassId.size() <= 100));
    }

    function isValidClass() {
      let data = request.resource.data;
      let keys = data.keys();
      return keys.size() <= 20
        && ('name' in keys && data.name is string && data.name.size() >= 1 && data.name.size() <= 50)
        && (!('teamCount' in keys) || (data.teamCount is int && data.teamCount >= 0 && data.teamCount <= 20))
        && (!('year' in keys) || (data.year is int && data.year >= 2020 && data.year <= 2100))
        && (!('grade' in keys) || (data.grade is string && data.grade.size() <= 20));
    }

    function isValidStudent() {
      let data = request.resource.data;
      let keys = data.keys();
      return keys.size() <= 15
        && (!('name' in keys) || (data.name is string && data.name.size() <= 30))
        && (!('number' in keys) || (data.number is int && data.number >= 0 && data.number <= 99))
        && (!('gender' in keys) || (data.gender is string && data.gender.size() <= 10))
        && (!('xp' in keys) || (data.xp is int && data.xp >= 0 && data.xp <= 100000));
    }

    // ── 사용자별 데이터 격리 ──

    match /users/{userId} {
      allow read: if request.auth != null
                   && request.auth.uid == userId;
      allow write: if request.auth != null
                    && request.auth.uid == userId
                    && isValidUserDoc();

      // 학급 서브컬렉션
      match /classes/{classId} {
        allow read: if request.auth != null
                     && request.auth.uid == userId;
        allow write: if request.auth != null
                      && request.auth.uid == userId
                      && isValidClass();

        // 학생 서브컬렉션
        match /students/{studentId} {
          allow read: if request.auth != null
                       && request.auth.uid == userId;
          allow write: if request.auth != null
                        && request.auth.uid == userId
                        && isValidStudent();
        }
      }
    }

    // 그 외 모든 경로 차단
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
